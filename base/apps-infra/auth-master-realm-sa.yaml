---
# Setup the master-sa for the Master Realm
apiVersion: v1.edp.epam.com/v1
kind: Keycloak
metadata:
  name: keycloak-initial
  namespace: auth
spec:
  secret: keycloak-keycloakx-admin-creds             # Secret name
  url: http://keycloak-keycloakx-http.auth.svc.cluster.local/auth   # Keycloak URL
---
apiVersion: v1.edp.epam.com/v1
kind: KeycloakRealm
metadata:
  name: master-initial
  namespace: auth
spec:
  realmName: master
  keycloakRef:
    kind: Keycloak
    name: keycloak-initial
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: keycloak-master-sa-secret
  namespace: auth
spec:
  refreshInterval: 1h
  refreshPolicy: CreatedOnce
  target:
    template:
      data:
        username: master-admin-sa
        password: "{{ .password }}"
  dataFrom:
    - sourceRef:
        generatorRef:
          apiVersion: generators.external-secrets.io/v1alpha1
          kind: Password
          name: keycloak-password
---
apiVersion: v1.edp.epam.com/v1
kind: KeycloakClient
metadata:
  name: master-admin-sa
  namespace: auth
spec:
  clientId: master-admin-sa
  name: Master Admin Service Account
  realmRef:
    name: master-initial
    kind: KeycloakRealm
  secret: $keycloak-master-sa-secret:password
  public: false
  protocol: openid-connect
  serviceAccount:
    enabled: true
    realmRoles:
      - offline_access
      - admin
    clientRoles:
      - clientId: master-realm
        roles:
          - manage-realm
---
apiVersion: v1.edp.epam.com/v1
kind: Keycloak
metadata:
  name: keycloak
  namespace: auth
spec:
  adminType: serviceAccount
  secret: keycloak-master-sa-secret             # Secret name
  url: http://keycloak-keycloakx-http.auth.svc.cluster.local/auth   # Keycloak URL
---
apiVersion: v1.edp.epam.com/v1
kind: KeycloakRealm
metadata:
  name: master
  namespace: auth
spec:
  realmName: master
  keycloakRef:
    kind: Keycloak
    name: keycloak
