---
# Use an client realm to
# ---
# apiVersion: external-secrets.io/v1
# kind: ExternalSecret
# metadata:
#   name: keycloak-master-sa-secret
#   namespace: auth
# spec:
#   refreshInterval: 1h
#   refreshPolicy: CreatedOnce
#   target:
#     template:
#       data:
#         username: master-admin-sa
#         password: "{{ .password }}"
#   dataFrom:
#     - sourceRef:
#         generatorRef:
#           apiVersion: generators.external-secrets.io/v1alpha1
#           kind: Password
#           name: keycloak-password
---
# kubectl -n auth create secret generic keycloak-master-sa --from-literal=username=master-admin-sa --from-literal=password="KEYCLOAK PASSWORD HERE"
---
apiVersion: v1.edp.epam.com/v1
kind: Keycloak
metadata:
  name: keycloak
  namespace: auth
spec:
  adminType: serviceAccount
  secret: keycloak-master-sa            # Secret name
  url: http://keycloak-keycloakx-http.auth.svc.cluster.local/auth   # Keycloak URL
---
apiVersion: v1.edp.epam.com/v1
kind: KeycloakRealm
metadata:
  name: master
  namespace: auth
spec:
  realmName: master
  keycloakRef:
    kind: Keycloak
    name: keycloak
---
apiVersion: v1.edp.epam.com/v1
kind: KeycloakClient
metadata:
  name: master-admin-sa
  namespace: auth
spec:
  clientId: master-admin-sa
  name: Master Admin Service Account
  realmRef:
    name: master
    kind: KeycloakRealm
  # Try to set the secret so that the creds can be managed by keycloak.. BUT likely this will result in
  # failed auth unless the secret is synced back from keycloak to the secret used here.
  secret: $keycloak-master-sa:password
  public: false
  protocol: openid-connect
  serviceAccount:
    enabled: true
    realmRoles:
      - offline_access
      - admin
    clientRoles:
      - clientId: master-realm
        roles:
          - manage-realm
